<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sign in to WhatToFlie</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; }
      #google { padding: 10px 16px; background: #4285f4; color: #fff; border: 0; border-radius: 6px; cursor: pointer; }
      #status { margin-top: 12px; color: #444; }
      #errors { margin-top: 8px; color: #c0392b; white-space: pre-wrap; }
      small { color: #666; }
    </style>
  </head>
  <body>
    <h2>Sign in</h2>
    <button id="google">Sign in with Google</button>
    <div id="status">Ready.</div>
    <div id="errors"></div>
    <small id="close-hint" style="display:none;">You can close this window.</small>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {{
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signInWithRedirect,
        getRedirectResult,
      }} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      // --- Query params / config
      const qs = new URLSearchParams(window.location.search);
      const isPopup = qs.get("popup") === "true";

      const firebaseConfig = {{
        apiKey: "AIzaSyA_dlivqpvqiYQVp0AC-yF1ZTkDSjIxVuE",
        authDomain: "whattoflie.firebaseapp.com",
        projectId: "whattoflie",
      }};

      // Where to send the user in non-popup mode
      const defaultReturnTo = "https://whattoflie.streamlit.app/";
      const returnTo = qs.get("return_to") || defaultReturnTo;

      // Parent origin for postMessage; prefer explicit param, then referrer, then returnTo
      const parentOrigin = (() => {{
        const fromParam = qs.get("parent_origin");
        if (fromParam) return fromParam;
        try {{
          if (document.referrer) return new URL(document.referrer).origin;
        }} catch {{}}
        try {{
          return new URL(returnTo).origin;
        }} catch {{}}
        return "*";
      }})();

      // --- DOM
      const statusEl = document.getElementById("status");
      const errorsEl = document.getElementById("errors");
      const closeHintEl = document.getElementById("close-hint");
      const btn = document.getElementById("google");

      // --- Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();
      // provider.setCustomParameters({{ prompt: "select_account" }});

      async function deliverAuthResult(user) {{
        const token = await user.getIdToken();
        const uid = user.uid;
        const email = user.email || "";

        if (isPopup && window.opener) {{
          try {{
            window.opener.postMessage({{ type: "auth_success", token, uid, email }}, parentOrigin);
          }} catch (e) {{
            // fallback permissive origin
            window.opener.postMessage({{ type: "auth_success", token, uid, email }}, "*");
          }}
          statusEl.textContent = "Signed in. Returning to app…";
          closeHintEl.style.display = "inline";
          setTimeout(() => {{ window.close(); }}, 150);
        }} else {{
          // Non-popup (or opener not present): redirect this window
          const target = new URL(returnTo);
          target.searchParams.set("token", token);
          target.searchParams.set("uid", uid);
          target.searchParams.set("email", encodeURIComponent(email));
          window.location = target.toString();
        }}
      }}

      // Handle redirect completion (if popup blocked)
      (async () => {{
        try {{
          const res = await getRedirectResult(auth);
          if (res && res.user) {{
            statusEl.textContent = "Signed in via redirect. Finishing…";
            await deliverAuthResult(res.user);
          }}
        }} catch (err) {{
          console.error("getRedirectResult error:", err);
        }}
      }})();

      btn.onclick = async () => {{
        errorsEl.textContent = "";
        statusEl.textContent = "Opening Google sign-in…";
        try {{
          const result = await signInWithPopup(auth, provider);
          statusEl.textContent = "Sign-in successful. Exchanging token…";
          await deliverAuthResult(result.user);
        }} catch (e) {{
          console.error("Popup auth error:", e);
          if (e?.code === "auth/popup-blocked" || e?.code === "auth/unauthorized-domain") {{
            statusEl.textContent = "Popup blocked or domain not authorized. Using redirect…";
            try {{
              await signInWithRedirect(auth, provider);
            }} catch (e2) {{
              errorsEl.textContent =
                `Redirect also failed.\\n` +
                `Error: ${{e2?.code || ""}} ${{e2?.message || e2}}\\n\\n` +
                `If you're developing locally, open the app at http://localhost:8501 ` +
                `or add ${{location.hostname}} under Firebase Auth → Settings → Authorized domains.`;
              statusEl.textContent = "Sign-in failed.";
            }}
          }} else if (e?.code === "auth/popup-closed-by-user" || e?.code === "auth/cancelled-popup-request") {{
            statusEl.textContent = "Popup closed before completing sign-in.";
          }} else {{
            errorsEl.textContent = `${{e?.code || ""}} ${{e?.message || e}}`;
            statusEl.textContent = "Sign-in failed.";
          }}
        }}
      }};
    </script>
  </body>
</html>
